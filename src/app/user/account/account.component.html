<!-- account.component.html -->
<div class="container account-page py-3">
  <div class="account-toolbar d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex gap-2">
      <button
        class="btn btn-sm btn-outline-secondary"
        (click)="refresh()"
        [disabled]="loading || saving">
        <span *ngIf="!loading">{{ 'REFRESH' | translate }}</span>
        <span *ngIf="loading" class="spinner-border spinner-border-sm" aria-hidden="true"></span>
      </button>

      <button
        *ngIf="!editMode"
        class="btn btn-sm btn-primary"
        (click)="enableEdit()">
        {{ 'EDIT' | translate }}
      </button>

      <ng-container *ngIf="editMode">
        <button
          class="btn btn-sm btn-success"
          (click)="save()"
          [disabled]="saving || form.invalid || !form.dirty">
          <span *ngIf="!saving">{{ 'SAVE' | translate }}</span>
          <span *ngIf="saving" class="spinner-border spinner-border-sm" aria-hidden="true"></span>
        </button>

        <button
          class="btn btn-sm btn-outline-light"
          (click)="cancelEdit()"
          [disabled]="saving">
          {{ 'CANCEL' | translate }}
        </button>
      </ng-container>
    </div>
  </div>

  <ng-container *ngIf="data as d">
    <div class="row g-3">

      <!-- Profile -->
      <div class="col-md-6">
        <div class="card acc-card h-100">
          <div class="card-header">{{ 'PROFILE' | translate }}</div>
          <div class="card-body">

            <!-- VIEW MODE -->
            <ng-container *ngIf="!editMode; else editForm">
              <div class="mb-2">
                <span class="label">{{ 'NAME' | translate }}</span>
                <span class="value">{{ fullName() }}</span>
              </div>

              <div class="mb-2">
                <span class="label">{{ 'EMAIL' | translate }}</span>
                <span class="value">{{ d.user.email }}</span>
              </div>

              <div class="mb-2">
                <span class="label">{{ 'COMPANY' | translate }}</span>
                <span class="value">{{ d.user.companyName || 'â€”' }}</span>
              </div>

              <div class="mb-2">
                <span class="label">{{ 'ROLE' | translate }}</span>
                <span class="value">{{ d.user.role }}</span>
              </div>

              <div class="mb-2">
                <span class="label">{{ 'STATUS' | translate }}</span>
                <span class="value">
                  {{ d.user.isActive ? ('ACTIVE' | translate) : ('INACTIVE' | translate) }}
                </span>
              </div>

              <div class="mb-2">
                <span class="label">{{ 'CREATED_AT' | translate }}</span>
                <span class="value">
                  {{ d.user.createdAt | date: 'medium' }}
                </span>
              </div>
            </ng-container>

            <!-- EDIT MODE -->
            <ng-template #editForm>
              <form [formGroup]="form" (ngSubmit)="save()" novalidate>
                <div class="row g-2">
                  <div class="col-sm-6">
                    <label class="form-label">{{ 'FIRST_NAME' | translate }}</label>
                    <input class="form-control" formControlName="firstName" />
                    <div *ngIf="f('firstName').touched && f('firstName').invalid" class="invalid small">
                      {{ 'FIRST_NAME_REQUIRED' | translate }}
                    </div>
                  </div>

                  <div class="col-sm-6">
                    <label class="form-label">{{ 'LAST_NAME' | translate }}</label>
                    <input class="form-control" formControlName="lastName" />
                    <div *ngIf="f('lastName').touched && f('lastName').invalid" class="invalid small">
                      {{ 'LAST_NAME_REQUIRED' | translate }}
                    </div>
                  </div>

                  <div class="col-12">
                    <label class="form-label">{{ 'COMPANY' | translate }}</label>
                    <input class="form-control" formControlName="companyName" />
                  </div>

                  <div class="col-sm-6">
                    <label class="form-label">
                      {{ 'NEW_PASSWORD' | translate }}
                      <span>({{ 'OPTIONAL' | translate }})</span>
                    </label>
                    <div class="input-wrap">
                      <input
                        [type]="showPass ? 'text' : 'password'"
                        autocomplete="new-password"
                        class="form-control"
                        formControlName="password"
                        [placeholder]="'PASSWORD_MIN_8_CHARS' | translate"
                        [ngClass]="{
                          'is-invalid': f('password').touched && f('password').invalid
                        }"
                      />
                      <button
                        type="button"
                        class="toggle-eye"
                        (click)="showPass = !showPass"
                        [attr.aria-label]="showPass ? ('HIDE' | translate) : ('SHOW' | translate)"
                      >
                        <fa-icon [icon]="showPass ? faEyeSlash : faEye"></fa-icon>
                      </button>
                    </div>
                    <div *ngIf="f('password').touched && f('password').errors?.['minlength']" class="invalid small">
                      {{ 'PASSWORD_MIN_8_CHARS' | translate }}
                    </div>
                  </div>

                  <div class="col-sm-6">
                    <label class="form-label">{{ 'CONFIRM_PASSWORD' | translate }}</label>
                    <div class="input-wrap">
                      <input
                        [type]="showConfirm ? 'text' : 'password'"
                        autocomplete="new-password"
                        class="form-control"
                        formControlName="confirm"
                        [ngClass]="{
                          'is-invalid':
                            (f('confirm').touched && f('confirm').invalid) ||
                            (form.touched && form.errors?.['mismatch'])
                        }"
                      />
                      <button
                        type="button"
                        class="toggle-eye"
                        (click)="showConfirm = !showConfirm"
                        [attr.aria-label]="showConfirm ? ('HIDE' | translate) : ('SHOW' | translate)"
                      >
                        <fa-icon [icon]="showConfirm ? faEyeSlash : faEye"></fa-icon>
                      </button>
                    </div>
                    <div *ngIf="f('confirm').touched && f('confirm').errors?.['required']" class="invalid small">
                      {{ 'CONFIRM_REQUIRED' | translate }}
                    </div>
                    <div *ngIf="form.touched && form.errors?.['mismatch']" class="invalid small">
                      {{ 'PASSWORDS_DO_NOT_MATCH' | translate }}
                    </div>
                  </div>
                </div>
              </form>
            </ng-template>

          </div>
        </div>
      </div>

      <!-- Credits -->
      <div class="col-md-6">
        <div class="card acc-card h-100">
          <div class="card-header">{{ 'CREDITS' | translate }}</div>
          <div class="card-body d-flex flex-column justify-content-center align-items-center">
            <div class="credits-number">{{ credits$ | async }}</div>
            <div class="small mb-3">{{ 'REMAINING_CREDITS' | translate }}</div>

            <button
              type="button"
              routerLink="/user/buy-credits"
              class="btn btn-buy w-30">
              {{ 'BUY_CREDITS' | translate }}
            </button>
          </div>
        </div>
      </div>

    </div>
  </ng-container>
</div>
