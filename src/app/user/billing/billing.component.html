<!-- src/app/user/billing/billing.component.html -->
<section class="container billing-page p-4">
  <div class="card-block billing-card">

    <!-- TOOLBAR -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 billing-toolbar">

      <div class="form-label small mb-0">
        {{ 'BILLING_HISTORY' | translate:{ default:'Billing history of packages purchased' } }}
      </div>

      <div class="d-flex flex-wrap align-items-stretch gap-3 justify-content-end">

        <!-- SORTING GROUP -->
        <div class="toolbar-section">
          <span class="toolbar-label">
            {{ 'SORTING' | translate:{ default:'Sorting' } }}
          </span>

          <div class="btn-group btn-group-sm billing-filters" role="group" aria-label="Filter by status">
            <button
              type="button"
              class="btn btn-filter"
              [class.active]="statusFilter === 'ALL'"
              (click)="setStatusFilter('ALL')">
              {{ 'FILTER_ALL' | translate:{ default:'All' } }}
            </button>

            <button
              type="button"
              class="btn btn-filter"
              [class.active]="statusFilter === 'SUCCESS'"
              (click)="setStatusFilter('SUCCESS')">
              {{ 'FILTER_SUCCESS' | translate:{ default:'Success' } }}
            </button>

            <button
              type="button"
              class="btn btn-filter"
              [class.active]="statusFilter === 'FAILED'"
              (click)="setStatusFilter('FAILED')">
              {{ 'FILTER_FAILED' | translate:{ default:'Failed' } }}
            </button>
          </div>
        </div>

        <!-- DOWNLOAD GROUP -->
        <div class="toolbar-section">
          <span class="toolbar-label">
            {{ 'DOWNLOAD' | translate:{ default:'Download' } }}
          </span>

          <div class="btn-group btn-group-sm billing-export" role="group" aria-label="Export">
            <button
              type="button"
              class="btn btn-export"
              (click)="exportCsv()">
              {{ 'EXPORT_CSV' | translate:{ default:'CSV' } }}
            </button>
            <button
              type="button"
              class="btn btn-export"
              (click)="exportExcel()">
              {{ 'EXPORT_EXCEL' | translate:{ default:'Excel' } }}
            </button>
          </div>
        </div>

        <!-- TABLE VIEW / COLUMNS GROUP – momentalno disabled -->
        <div class="toolbar-section d-none d-md-flex">
          <span class="toolbar-label">
            {{ 'TABLE_VIEW' | translate:{ default:'Table view' } }}
          </span>

          <div class="billing-column-chooser">
            <button
              type="button"
              class="btn btn-export btn-sm"
              (click)="toggleColumnPanel()">
              {{ 'COLUMNS' | translate:{ default:'Columns' } }}
            </button>

            <div class="billing-column-panel mt-2" *ngIf="showColumnPanel">
              <div class="small fw-semibold mb-1">
                {{ 'VISIBLE_COLUMNS' | translate:{ default:'Visible columns' } }}
              </div>

              <div
                *ngFor="let col of columnChooser"
                class="form-check form-check-sm mb-1">
                <input
                  class="form-check-input"
                  type="checkbox"
                  [checked]="col.visible"
                  [disabled]="col.lock"
                  (change)="onToggleColumn(col, $event)">
                <label class="form-check-label">
                  {{ col.label }}
                  <span *ngIf="col.lock" class="text-muted">
                    ({{ 'FIXED' | translate:{ default:'fixed' } }})
                  </span>
                </label>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- DESKTOP GRID (hidden on mobile, но постои за export) -->
    <div class="billing-grid-wrapper" [class.grid-hidden]="isMobile">
      <ag-grid-angular
        [theme]="theme"
        [columnDefs]="columnDefs"
        [defaultColDef]="defaultColDef"
        [rowData]="rowData"
        [pagination]="true"
        [paginationPageSize]="10"
        [paginationPageSizeSelector]="[10, 20, 50, 100]"
        style="width: 100%; height: 57vh"
        (gridReady)="onGridReady($event)">
      </ag-grid-angular>
    </div>


    <!-- MOBILE: accordion cards -->
    <div *ngIf="isMobile" class="billing-mobile-list mt-3">
      <div class="accordion" id="billingAccordion">
        <div
          class="accordion-item"
          *ngFor="let row of rowData; let i = index">
          <h2 class="accordion-header" [id]="'heading' + i">
            <button
              class="accordion-button collapsed mobile-acc-btn"
              type="button"
              data-bs-toggle="collapse"
              [attr.data-bs-target]="'#collapse' + i"
              aria-expanded="false"
              [attr.aria-controls]="'collapse' + i">

              <div class="acc-main-line">
                <span class="acc-id">#{{ row.id }}</span>
                <span class="acc-amount">
                  {{ row.amount | number:'1.0-0' }} €
                </span>
              </div>

              <div class="acc-sub-line">
                {{ row.timestamp | date:'dd/MM/yyyy, HH:mm' }}
              </div>
            </button>
          </h2>

          <div
            [id]="'collapse' + i"
            class="accordion-collapse collapse"
            [attr.aria-labelledby]="'heading' + i"
            data-bs-parent="#billingAccordion">
            <div class="accordion-body">

              <div class="acc-row">
                <span class="acc-label">
                  {{ 'PACKAGE_NAME' | translate }}
                </span>
                <span class="acc-value">
                  {{ row.packageName }}
                </span>
              </div>

              <div class="acc-row">
                <span class="acc-label">
                  {{ 'PACKAGE_CREDITS' | translate }}
                </span>
                <span class="acc-value">
                  {{ row.packageCredits }}
                </span>
              </div>

              <div class="acc-row">
                <span class="acc-label">
                  {{ 'PACKAGE_PRICE' | translate }}
                </span>
                <span class="acc-value">
                  {{ row.packagePrice | number:'1.0-0' }} €
                </span>
              </div>

              <div class="acc-row">
                <span class="acc-label">
                  {{ 'DISCOUNT_PERCENT' | translate }}
                </span>
                <span class="acc-value">
                  {{ row.packageDiscountPercentage }} %
                </span>
              </div>

              <div class="acc-row">
                <span class="acc-label">
                  {{ 'CREDITS' | translate }}
                </span>
                <span class="acc-value">
                  {{ row.credits }}
                </span>
              </div>

              <div class="acc-row">
                <span class="acc-label">
                  {{ 'STATUS' | translate }}
                </span>
                <span class="acc-value">
                  <span class="badge bg-success" *ngIf="row.status === 'SUCCESS'">
                    {{ 'FILTER_SUCCESS' | translate }}
                  </span>
                  <span class="badge bg-danger" *ngIf="row.status === 'FAILED'">
                    {{ 'FILTER_FAILED' | translate }}
                  </span>
                </span>
              </div>

              <div class="acc-row acc-row-button d-flex gap-2">
                <button type="button" class="btn btn-outline-primary btn-sm w-100"
                  (click)="downloadInvoicePdf(row)">
                  {{ 'INVOICE' | translate:{ default:'Invoice' } }}
                </button>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>
