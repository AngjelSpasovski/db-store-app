<!-- src/app/admin/users-list/users-list.component.html -->
<section class="container admin-users-page p-3 p-md-4">
  <div class="card-block admin-users-card">

    <!-- TOOLBAR -->
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 admin-toolbar">

      <div class="form-label mb-0">
        {{ 'ADMIN.USERS' | translate:{ default:'Users' } }}
      </div>

      <div class="d-flex flex-wrap align-items-stretch gap-3 justify-content-end admin-toolbar-right">

        <!-- SEARCH -->
        <div class="toolbar-section toolbar-search">
          <span class="toolbar-label">
            {{ 'SEARCH' | translate:{ default:'Search' } }}
          </span>

          <input
            type="text"
            class="form-control form-control-sm search-input"
            [(ngModel)]="searchText"
            (input)="applyQuickFilter()"
            [placeholder]="'ADMIN.SEARCH_USERS_PLACEHOLDER' | translate:{ default:'Search users…' }" />

          <button
            type="button"
            class="btn btn-sm btn-clear"
            *ngIf="searchText"
            (click)="clearSearch()"
            aria-label="Clear search">
            ✕
          </button>
        </div>

        <!-- PER PAGE -->
        <div class="toolbar-section">
          <span class="toolbar-label">
            {{ 'ADMIN.PER_PAGE' | translate:{ default:'Per page' } }}
          </span>

          <select
            [(ngModel)]="perPage"
            (change)="reload()"
            class="form-select form-select-sm w-auto">
            <option *ngFor="let p of pageOptions" [value]="p">{{ p }}</option>
          </select>
        </div>

        <!-- ACTIONS -->
        <div class="toolbar-section">
          <span class="toolbar-label">
            {{ 'ADMIN.ACTIONS' | translate:{ default:'Actions' } }}
          </span>

          <button type="button" class="btn btn-export btn-sm" (click)="load()">
            {{ 'REFRESH' | translate:{ default:'Refresh' } }}
          </button>
        </div>

      </div>
    </div>

    <!-- DESKTOP GRID (hidden on mobile, but stays mounted) -->
    <div class="admin-grid-wrapper" [class.grid-hidden]="isMobile">
      <ag-grid-angular
        class="ag-theme-alpine"
        [theme]="theme"
        [gridOptions]="gridOptions"
        [columnDefs]="columnDefs"
        [defaultColDef]="defaultColDef"
        [rowData]="rows"
        [pagination]="false"
        style="width: 100%; height: 57vh"
        (gridReady)="onGridReady($event)">
      </ag-grid-angular>
    </div>

    <!-- MOBILE: accordion cards (like Billing) -->
    <div *ngIf="isMobile" class="admin-mobile-list mt-3">
      <div class="accordion" id="usersAccordion">

        <div class="accordion-item" *ngFor="let u of filteredRows; let i = index">
          <h2 class="accordion-header" [id]="'uHead' + i">
            <button
              class="accordion-button collapsed mobile-acc-btn"
              type="button"
              data-bs-toggle="collapse"
              [attr.data-bs-target]="'#uCol' + i"
              aria-expanded="false"
              [attr.aria-controls]="'uCol' + i">

              <div class="acc-main-line">
                <span class="acc-id">#{{ u.id }}</span>

                <span class="acc-right">
                  <span class="badge"
                        [class.bg-success]="u.isActive"
                        [class.bg-secondary]="!u.isActive">
                    {{ u.isActive ? ('ADMIN.YES' | translate:{default:'Yes'}) : ('ADMIN.NO' | translate:{default:'No'}) }}
                  </span>
                </span>
              </div>

              <div class="acc-sub-line">
                <span class="acc-name">
                  {{ (u.firstName || '') + ' ' + (u.lastName || '') || '-' }}
                </span>
                <span class="acc-email">{{ u.email }}</span>
              </div>
            </button>
          </h2>

          <div [id]="'uCol' + i" class="accordion-collapse collapse"
               [attr.aria-labelledby]="'uHead' + i" data-bs-parent="#usersAccordion">

            <div class="accordion-body">

              <!-- COMPANY -->
              <div class="acc-row" *ngIf="u.companyName">
                <span class="acc-label">{{ 'COMPANY' | translate:{default:'Company'} }}</span>
                <span class="acc-value">{{ u.companyName }}</span>
              </div>
              <!-- ROLE -->
              <div class="acc-row">
                <span class="acc-label">{{ 'ROLE' | translate:{default:'Role'} }}</span>
                <span class="acc-value">{{ u.role }}</span>
              </div>
              <!-- CREATED AT -->
              <div class="acc-row" *ngIf="u.createdAt">
                <span class="acc-label">{{ 'CREATED_AT' | translate:{default:'Created'} }}</span>
                <span class="acc-value">{{ u.createdAt | date:'dd/MM/yyyy' }}</span>
              </div>
              <!-- UPDATED AT -->
              <div class="acc-row" *ngIf="u.updatedAt">
                <span class="acc-label">{{ 'ADMIN.UPDATED_AT' | translate:{default:'Updated'} }}</span>
                <span class="acc-value">{{ u.updatedAt | date:'dd/MM/yyyy' }}</span>
              </div>

              <div class="acc-row acc-row-button d-flex gap-2">
                <!-- VIEW DETAILS BUTTON -->
                <button type="button"
                        class="btn btn-outline-light btn-sm w-100"
                        (click)="openDetails(u)">
                  {{ 'VIEW' | translate:{default:'View'} }}
                </button>

                <!-- TOGGLE ACTIVE BUTTON -->
                <button type="button"
                        class="btn btn-sm w-100"
                        [class.btn-success]="!u.isActive"
                        [class.btn-danger]="u.isActive"
                        [disabled]="u.role === 'superadmin' || togglingId === u.id"
                        (click)="openConfirmToggle(u)">
                  {{ togglingId === u.id ? ('LOADING' | translate:{default:'Loading'}) : (u.isActive ? ('DEACTIVATE' | translate:{default:'Deactivate'}) : ('ACTIVATE' | translate:{default:'Activate'})) }}
                </button>

                <!-- ASSIGN PACKAGES BUTTON -->
                <!-- <button type="button"
                        class="btn btn-outline-info btn-sm w-100"
                        [disabled]="!isSuperadmin"
                        (click)="openPackages(u)">
                  {{ 'ADMIN.ASSIGN_PACKAGES' | translate:{default:'Packages'} }}
                </button> -->
              </div>

              <div class="small text-muted mt-2" *ngIf="u.role === 'superadmin'">
                {{ 'ADMIN.CANNOT_TOGGLE_SUPERADMIN' | translate:{ default:'Superadmin status cannot be changed.' } }}
              </div>

            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- SERVER PAGER -->
    <div class="admin-pager d-flex justify-content-between align-items-center mt-3">
      <button class="btn btn-outline-light btn-sm"
              [disabled]="page <= 1"
              (click)="prevPage()">
        {{ 'PREVIOUS' | translate:{ default:'Previous' } }}
      </button>

      <div class="small text-muted">
        {{ 'ADMIN.PAGE' | translate:{ default:'Page' } }} {{ page }} / {{ totalPages }}
        · {{ 'ADMIN.TOTAL' | translate:{ default:'Total' } }}: {{ total }}
      </div>

      <button class="btn btn-outline-light btn-sm"
              [disabled]="page >= totalPages"
              (click)="nextPage()">
        {{ 'NEXT' | translate:{ default:'Next' } }}
      </button>
    </div>

  </div>

  <!-- BLUR BACKDROP (for View + Confirm + Packages) -->
  <div class="modal-backdrop blur show" *ngIf="detailsVisible || confirmVisible || packagesVisible"></div>

  <!-- VIEW MODAL -->
  <div class="custom-modal" *ngIf="detailsVisible">
    <div class="custom-modal-dialog">
      <div class="custom-modal-content glass">
        <div class="custom-modal-header">
          <h5 class="modal-title">
            {{ 'ADMIN.USER_DETAILS_TITLE' | translate:{ default:'User details' } }}
            – {{ selectedUser?.firstName }} {{ selectedUser?.lastName }}
          </h5>

          <button type="button"
                  class="btn-close btn-close-white"
                  (click)="closeDetails()"></button>
        </div>

        <div class="custom-modal-body" *ngIf="selectedUser">
          <div class="row">
            <div class="col-4 fw-semibold">ID</div>
            <div class="col-8">{{ selectedUser.id }}</div>

            <div class="col-4 fw-semibold mt-2">{{ 'EMAIL' | translate:{default:'Email'} }}</div>
            <div class="col-8 mt-2">{{ selectedUser.email }}</div>

            <div class="col-4 fw-semibold mt-2">{{ 'COMPANY' | translate:{default:'Company'} }}</div>
            <div class="col-8 mt-2">{{ selectedUser.companyName || '-' }}</div>

            <div class="col-4 fw-semibold mt-2">{{ 'FIRST_NAME' | translate:{default:'First name'} }}</div>
            <div class="col-8 mt-2">{{ selectedUser.firstName || '-' }}</div>

            <div class="col-4 fw-semibold mt-2">{{ 'LAST_NAME' | translate:{default:'Last name'} }}</div>
            <div class="col-8 mt-2">{{ selectedUser.lastName || '-' }}</div>

            <div class="col-4 fw-semibold mt-2">{{ 'ROLE' | translate:{default:'Role'} }}</div>
            <div class="col-8 mt-2">{{ selectedUser.role }}</div>

            <div class="col-4 fw-semibold mt-2">{{ 'ACTIVE' | translate:{default:'Active'} }}</div>
            <div class="col-8 mt-2">
              <span class="badge"
                    [class.bg-success]="selectedUser.isActive"
                    [class.bg-secondary]="!selectedUser.isActive">
                {{ selectedUser.isActive ? ('ADMIN.YES' | translate:{default:'Yes'}) : ('ADMIN.NO' | translate:{default:'No'}) }}
              </span>
            </div>

            <div class="col-4 fw-semibold mt-2">{{ 'CREATED_AT' | translate:{default:'Created'} }}</div>
            <div class="col-8 mt-2">{{ selectedUser.createdAt || '-' }}</div>

            <div class="col-4 fw-semibold mt-2">{{ 'ADMIN.UPDATED_AT' | translate:{default:'Updated'} }}</div>
            <div class="col-8 mt-2">{{ selectedUser.updatedAt || '-' }}</div>
          </div>
        </div>

        <div class="custom-modal-footer">
          <button class="btn btn-secondary" (click)="closeDetails()">
            {{ 'CLOSE' | translate:{default:'Close'} }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- CONFIRM MODAL -->
  <div class="custom-modal" *ngIf="confirmVisible">
    <div class="custom-modal-dialog confirm-dialog">
      <div class="custom-modal-content glass">
        <div class="custom-modal-header">
          <h5 class="modal-title">
            {{ confirmNextActive ? ('ACTIVATE' | translate:{default:'Activate'}) : ('DEACTIVATE' | translate:{default:'Deactivate'}) }}
          </h5>

          <button type="button"
                  class="btn-close btn-close-white"
                  (click)="closeConfirm()"></button>
        </div>

        <div class="custom-modal-body" *ngIf="confirmUser">
          <div class="confirm-text">
            {{ 'ADMIN.CONFIRM_TOGGLE' | translate:{ default:'Are you sure you want to change status for' } }}
            <span class="fw-semibold">{{ confirmUser.email }}</span>?
          </div>

          <div class="small text-muted mt-2" *ngIf="confirmUser.role === 'superadmin'">
            {{ 'ADMIN.CANNOT_TOGGLE_SUPERADMIN' | translate:{ default:'Superadmin status cannot be changed.' } }}
          </div>
        </div>

        <div class="custom-modal-footer d-flex justify-content-end gap-2">
          <button class="btn btn-outline-light" (click)="closeConfirm()">
            {{ 'CANCEL' | translate:{default:'Cancel'} }}
          </button>

          <button class="btn"
                  [class.btn-success]="confirmNextActive"
                  [class.btn-danger]="!confirmNextActive"
                  [disabled]="confirmBusy"
                  (click)="confirmToggle()">
            {{ confirmBusy ? ('LOADING' | translate:{default:'Loading'}) : ('ADMIN.CONFIRM' | translate:{default:'Confirm'}) }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- PACKAGES MODAL -->
  <div class="custom-modal" *ngIf="packagesVisible">
    <div class="custom-modal-dialog">
      <div class="custom-modal-content glass">
        <div class="custom-modal-header">
          <h5 class="modal-title">
            {{ 'ADMIN.ASSIGN_PACKAGES' | translate:{ default:'Assign packages' } }}
            – {{ packagesUser?.email }}
          </h5>

          <button type="button" class="btn-close btn-close-white" (click)="closePackages()"></button>
        </div>

        <div class="custom-modal-body">
          <app-user-packages-modal
            *ngIf="packagesUser"
            [userId]="packagesUser.id"
            [userEmail]="packagesUser.email"
            (close)="closePackages()"
            (changed)="load()">
          </app-user-packages-modal>
        </div>
      </div>
    </div>
  </div>

</section>
